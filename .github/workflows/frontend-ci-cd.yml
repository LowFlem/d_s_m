name: ðŸŒ Frontend CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'dsm_client/new_frontend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'dsm_client/new_frontend/**'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'

jobs:
  # ============================================================================
  # FRONTEND CODE QUALITY & SECURITY
  # ============================================================================
  frontend-quality:
    name: ðŸ§¹ Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ” TypeScript type checking
        working-directory: dsm_client/new_frontend
        run: npm run type-check
        
      - name: ðŸ“‹ ESLint analysis
        working-directory: dsm_client/new_frontend
        run: npm run lint
        
      - name: ðŸŽ¨ Prettier format check
        working-directory: dsm_client/new_frontend
        run: npm run format:check
        
      - name: ðŸ”’ Security audit
        working-directory: dsm_client/new_frontend
        run: npm audit --audit-level high
        continue-on-error: true
        
      - name: ðŸ“Š Bundle size check
        working-directory: dsm_client/new_frontend
        run: npm run size-limit
        continue-on-error: true

  # ============================================================================
  # FRONTEND TESTING
  # ============================================================================
  frontend-tests:
    name: ðŸ§ª Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ§ª Run unit tests
        working-directory: dsm_client/new_frontend
        run: npm run test:coverage
        
      - name: ðŸŽ­ Run component tests
        working-directory: dsm_client/new_frontend
        run: npm run test:components
        continue-on-error: true
        
      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: dsm_client/new_frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
          
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: frontend-test-results
          path: |
            dsm_client/new_frontend/coverage/
            dsm_client/new_frontend/test-results.xml
          retention-days: 7

  # ============================================================================
  # DSM BRIDGE INTEGRATION TESTS
  # ============================================================================
  dsm-bridge-tests:
    name: ðŸ”— DSM Bridge Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ”— Test DSM bridge interface
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ”— Testing DSM bridge TypeScript interfaces..."
          npm run test:bridge
          
      - name: ðŸ§ª Test protocol binding chains
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ§ª Testing protocol binding chains..."
          
          # Check if bridge methods are properly typed
          npx tsc --noEmit src/types/dsm-bridge.ts
          
          # Test hook implementations
          npx tsc --noEmit src/hooks/useBridge.ts
          
      - name: ðŸ” Test component integration
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ” Testing DSM component integration..."
          
          # Test screen components
          npm run test:screens
          
          # Test wallet functionality
          npm run test:wallet

  # ============================================================================
  # FRONTEND BUILD MATRIX
  # ============================================================================
  frontend-build:
    name: ðŸ—ï¸ Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-quality, frontend-tests]
    
    strategy:
      matrix:
        build-type:
          - { name: "development", command: "build:dev", env: "development" }
          - { name: "production", command: "build:production", env: "production" }
          - { name: "android", command: "build:android", env: "android" }
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ—ï¸ Build ${{ matrix.build-type.name }}
        working-directory: dsm_client/new_frontend
        env:
          NODE_ENV: ${{ matrix.build-type.env }}
        run: |
          echo "ðŸ—ï¸ Building frontend for ${{ matrix.build-type.name }}..."
          npm run ${{ matrix.build-type.command }}
          
      - name: ðŸ“Š Build analysis
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ“Š Build Analysis for ${{ matrix.build-type.name }}:"
          echo "================================================="
          
          if [ -d "dist" ]; then
            echo "ðŸ“‚ Distribution size:"
            du -sh dist/
            
            echo ""
            echo "ðŸ“„ Key files:"
            find dist -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | xargs ls -lh
            
            echo ""
            echo "ðŸ” Bundle composition:"
            if [ -f "dist/bundle-analyzer-report.html" ]; then
              echo "âœ… Bundle analyzer report generated"
            fi
            
            # Check for DSM-specific files
            echo ""
            echo "ðŸ”— DSM Protocol files:"
            find dist -name "*bridge*" -o -name "*dsm*" -o -name "*wallet*" | head -5
            
            # Check for critical files
            echo ""
            echo "âœ… Critical file verification:"
            if [ -f "dist/index.html" ]; then
              echo "  âœ… index.html"
            else
              echo "  âŒ index.html missing"
            fi
            
            if find dist -name "*.js" | grep -q .; then
              echo "  âœ… JavaScript bundles"
            else
              echo "  âŒ JavaScript bundles missing"
            fi
            
            if find dist -name "*.css" | grep -q .; then
              echo "  âœ… CSS stylesheets"
            else
              echo "  âŒ CSS stylesheets missing"
            fi
          else
            echo "âŒ Distribution directory not found"
            exit 1
          fi
          
      - name: ðŸ§ª Smoke test build
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ§ª Running smoke tests on build..."
          
          # Test that critical files exist and are not empty
          if [ -f "dist/index.html" ] && [ -s "dist/index.html" ]; then
            echo "âœ… index.html is valid"
          else
            echo "âŒ index.html is invalid or empty"
            exit 1
          fi
          
          # Test that JS bundles are not empty
          for js_file in $(find dist -name "*.js" | head -3); do
            if [ -s "$js_file" ]; then
              echo "âœ… $(basename $js_file) is valid"
            else
              echo "âŒ $(basename $js_file) is empty"
              exit 1
            fi
          done
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-${{ matrix.build-type.name }}-${{ github.sha }}
          path: dsm_client/new_frontend/dist/
          retention-days: 7

  # ============================================================================
  # ANDROID ASSETS DEPLOYMENT
  # ============================================================================
  android-deployment:
    name: ðŸ“± Android Assets Deployment
    runs-on: ubuntu-latest
    needs: [frontend-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¥ Download Android build
        uses: actions/download-artifact@v4
        with:
          name: frontend-android-${{ github.sha }}
          path: dsm_client/new_frontend/dist/
          
      - name: ðŸ“¦ Install deployment dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ§¹ Clean Android assets
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸ§¹ Cleaning Android assets directory..."
          rm -rf ../android/app/src/main/assets/*
          
      - name: ðŸš€ Deploy to Android assets
        working-directory: dsm_client/new_frontend
        run: |
          echo "ðŸš€ Deploying frontend to Android assets..."
          npm run deploy:android-complete
          
      - name: âœ… Verify Android deployment
        run: |
          echo "âœ… Verifying Android asset deployment..."
          
          ANDROID_ASSETS="dsm_client/android/app/src/main/assets"
          
          if [ -d "$ANDROID_ASSETS" ]; then
            echo "ðŸ“Š Android assets deployed:"
            ls -la "$ANDROID_ASSETS"
            
            echo ""
            echo "ðŸ” Key file verification:"
            
            # Check index.html
            if [ -f "$ANDROID_ASSETS/index.html" ]; then
              echo "  âœ… index.html deployed"
              
              # Check if it contains DSM-specific content
              if grep -q "DSM Wallet" "$ANDROID_ASSETS/index.html"; then
                echo "  âœ… DSM Wallet content found"
              else
                echo "  âš ï¸ DSM Wallet content missing from index.html"
              fi
            else
              echo "  âŒ index.html missing"
              exit 1
            fi
            
            # Check JavaScript bundles
            if find "$ANDROID_ASSETS" -name "*.js" | grep -q .; then
              echo "  âœ… JavaScript bundles deployed"
              echo "    ðŸ“Š JS files:"
              find "$ANDROID_ASSETS" -name "*.js" | head -5 | xargs ls -lh
            else
              echo "  âŒ JavaScript bundles missing"
              exit 1
            fi
            
            # Check CSS files
            if find "$ANDROID_ASSETS" -name "*.css" | grep -q .; then
              echo "  âœ… CSS stylesheets deployed"
            else
              echo "  âš ï¸ CSS stylesheets missing"
            fi
            
            # Check DSM bridge files
            if find "$ANDROID_ASSETS" -name "*bridge*" -o -name "*dsm*" | grep -q .; then
              echo "  âœ… DSM bridge files found"
            else
              echo "  âš ï¸ DSM bridge files not found"
            fi
            
            echo ""
            echo "ðŸ“ Total asset size:"
            du -sh "$ANDROID_ASSETS"
            
          else
            echo "âŒ Android assets directory not found"
            exit 1
          fi
          
      - name: ðŸ”’ Security headers verification
        run: |
          echo "ðŸ”’ Verifying security headers in deployed assets..."
          
          INDEX_FILE="dsm_client/android/app/src/main/assets/index.html"
          
          if [ -f "$INDEX_FILE" ]; then
            # Check for CSP headers
            if grep -q "Content-Security-Policy" "$INDEX_FILE"; then
              echo "  âœ… Content Security Policy found"
            else
              echo "  âš ï¸ Content Security Policy missing"
            fi
            
            # Check for other security headers
            if grep -q "X-Frame-Options\|X-Content-Type-Options" "$INDEX_FILE"; then
              echo "  âœ… Additional security headers found"
            else
              echo "  âš ï¸ Additional security headers missing"
            fi
          fi
          
      - name: Upload Android assets
        uses: actions/upload-artifact@v3
        with:
          name: android-assets-deployed-${{ github.sha }}
          path: dsm_client/android/app/src/main/assets/
          retention-days: 30

  # ============================================================================
  # E2E FRONTEND TESTS
  # ============================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Frontend Tests
    runs-on: ubuntu-latest
    needs: [android-deployment]
    if: github.ref == 'refs/heads/main'  # Only run on main due to resource cost
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dsm_client/new_frontend/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        working-directory: dsm_client/new_frontend
        run: npm ci
        
      - name: ðŸ“¥ Download production build
        uses: actions/download-artifact@v4
        with:
          name: frontend-production-${{ github.sha }}
          path: dsm_client/new_frontend/dist/
          
      - name: ðŸš€ Start test server
        working-directory: dsm_client/new_frontend
        run: |
          npm run serve:dist &
          echo $! > server.pid
          
          # Wait for server to start
          sleep 10
          
          # Verify server is running
          curl -f http://localhost:3000 || exit 1
          
      - name: ðŸŽ­ Run E2E tests
        working-directory: dsm_client/new_frontend
        run: |
          npm run test:e2e
          
      - name: ðŸ›‘ Stop test server
        working-directory: dsm_client/new_frontend
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
          
      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            dsm_client/new_frontend/e2e-results/
            dsm_client/new_frontend/screenshots/
          retention-days: 7

  # ============================================================================
  # FRONTEND PERFORMANCE ANALYSIS
  # ============================================================================
  performance-analysis:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    needs: [frontend-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download production build
        uses: actions/download-artifact@v4
        with:
          name: frontend-production-${{ github.sha }}
          path: dist/
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“Š Bundle size analysis
        run: |
          echo "ðŸ“Š Bundle Size Analysis"
          echo "======================"
          
          echo "ðŸ“ Total bundle size:"
          du -sh dist/
          
          echo ""
          echo "ðŸ“„ Individual file sizes:"
          find dist -name "*.js" -o -name "*.css" -exec ls -lh {} \; | sort -k5 -hr | head -10
          
          echo ""
          echo "ðŸ” Gzip simulation:"
          find dist -name "*.js" -o -name "*.css" | while read file; do
            original_size=$(stat -c%s "$file")
            gzip_size=$(gzip -c "$file" | wc -c)
            echo "$(basename "$file"): ${original_size} â†’ ${gzip_size} bytes ($(echo "scale=1; $gzip_size * 100 / $original_size" | bc)%)"
          done | head -5
          
      - name: âš¡ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: dsm_client/new_frontend/lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: ðŸ“Š Performance report
        run: |
          echo "ðŸ“Š Performance Analysis Summary"
          echo "=============================="
          echo "âœ… Bundle size analysis completed"
          echo "âœ… Lighthouse performance audit completed"
          echo "ðŸ“Š See artifacts for detailed reports"

  # ============================================================================
  # RELEASE PREPARATION
  # ============================================================================
  release:
    name: ðŸ“¦ Frontend Release
    runs-on: ubuntu-latest
    needs: [android-deployment, performance-analysis]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: frontend-*-${{ github.sha }}
          path: release-artifacts/
          merge-multiple: true
          
      - name: ðŸ“¥ Download Android assets
        uses: actions/download-artifact@v4
        with:
          name: android-assets-deployed-${{ github.sha }}
          path: release-artifacts/android-assets/
          
      - name: ðŸ“¦ Package release
        run: |
          mkdir -p release/frontend
          
          # Copy production build
          if [ -d "release-artifacts/frontend-production-${{ github.sha }}" ]; then
            cp -r "release-artifacts/frontend-production-${{ github.sha }}"/* release/frontend/
          fi
          
          # Copy Android assets
          mkdir -p release/android-assets
          if [ -d "release-artifacts/android-assets" ]; then
            cp -r release-artifacts/android-assets/* release/android-assets/
          fi
          
          # Create release metadata
          cat > release/FRONTEND_RELEASE.md << EOF
          # DSM Wallet Frontend Release
          
          **Commit:** ${{ github.sha }}
          **Date:** $(date)
          **Node Version:** ${{ env.NODE_VERSION }}
          
          ## ðŸ“¦ Release Contents
          - Production frontend build
          - Android assets deployment
          - Performance analysis reports
          
          ## âœ… Quality Gates Passed
          - âœ… TypeScript type checking
          - âœ… ESLint analysis
          - âœ… Unit tests with coverage
          - âœ… Bundle size optimization
          - âœ… Security audit
          - âœ… Android deployment verified
          
          ## ðŸ“Š Build Statistics
          $(du -sh release/frontend)
          
          ## ðŸ” Security Features
          - Content Security Policy headers
          - XSS protection
          - Secure DSM bridge interface
          - Post-quantum cryptography integration
          EOF
          
      - name: Upload release package
        uses: actions/upload-artifact@v3
        with:
          name: dsm-frontend-release-${{ github.sha }}
          path: release/
          retention-days: 90
          
      - name: ðŸ“Š Release summary
        run: |
          echo "ðŸ“Š DSM Frontend Release Summary"
          echo "=============================="
          echo "ðŸ“¦ Frontend build: $(du -sh release/frontend | cut -f1)"
          echo "ðŸ“± Android assets: $(du -sh release/android-assets | cut -f1)"
          echo "ðŸ“„ Release notes: release/FRONTEND_RELEASE.md"
          echo ""
          echo "âœ… Frontend release package ready for deployment"
